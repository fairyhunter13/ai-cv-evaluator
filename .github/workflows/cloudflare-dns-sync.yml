name: Cloudflare DNS Sync

on:
  workflow_dispatch:
    inputs:
      target_ip:
        description: "Override A record target IP (defaults to SSH_HOST secret)"
        required: false
        default: ""

  workflow_run:
    workflows: ["Deploy"]
    types:
      - completed

concurrency:
  group: cloudflare-dns-sync-${{ github.event.workflow_run.head_branch || github.ref }}
  cancel-in-progress: true

jobs:
  sync-dns:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' || (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')
    env:
      CF_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      CF_ZONE_ID: ${{ secrets.CLOUDFLARE_ZONE_ID }}
      SSH_HOST: ${{ secrets.SSH_HOST }}
      TARGET_IP_OVERRIDE: ${{ github.event.inputs.target_ip }}
    steps:
      - name: Install jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Upsert DNS records for production hostnames
        run: |
          set -euo pipefail

          if [ -z "${CF_API_TOKEN}" ] || [ -z "${CF_ZONE_ID}" ]; then
            echo "CLOUDFLARE_API_TOKEN or CLOUDFLARE_ZONE_ID not set" >&2
            exit 1
          fi

          TARGET_IP="${TARGET_IP_OVERRIDE:-$SSH_HOST}"
          if [ -z "${TARGET_IP}" ]; then
            echo "TARGET_IP is empty; set SSH_HOST secret or provide target_ip input" >&2
            exit 1
          fi

          records=(
            "ai-cv-evaluator.web.id"
            "dashboard.ai-cv-evaluator.web.id"
            "keycloak.ai-cv-evaluator.web.id"
          )

          api_base="https://api.cloudflare.com/client/v4"

          for name in "${records[@]}"; do
            echo "Syncing A record for ${name} -> ${TARGET_IP}"

            existing=$(curl -s -X GET "${api_base}/zones/${CF_ZONE_ID}/dns_records?type=A&name=${name}" \
              -H "Authorization: Bearer ${CF_API_TOKEN}" \
              -H "Content-Type: application/json")

            id=$(echo "${existing}" | jq -r '.result[0].id // empty')

            data=$(jq -n --arg name "${name}" --arg ip "${TARGET_IP}" '{type:"A", name:$name, content:$ip, ttl:300, proxied:true}')

            if [ -n "${id}" ]; then
              echo "Updating existing record ${id} for ${name}"
              curl -s -X PUT "${api_base}/zones/${CF_ZONE_ID}/dns_records/${id}" \
                -H "Authorization: Bearer ${CF_API_TOKEN}" \
                -H "Content-Type: application/json" \
                -d "${data}" | jq '.success, .errors'
            else
              echo "Creating new record for ${name}"
              curl -s -X POST "${api_base}/zones/${CF_ZONE_ID}/dns_records" \
                -H "Authorization: Bearer ${CF_API_TOKEN}" \
                -H "Content-Type: application/json" \
                -d "${data}" | jq '.success, .errors'
            fi
          done
