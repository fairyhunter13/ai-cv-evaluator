name: Secrets Healthcheck

on:
  workflow_dispatch:
  schedule:
    - cron: "0 1 * * *" # 01:00 UTC daily

jobs:
  healthcheck:
    runs-on: ubuntu-latest
    steps:
      - name: Groq account 1 - models endpoint
        if: ${{ secrets.GROQ_API_KEY != '' }}
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
        run: |
          set -euo pipefail
          status=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: Bearer ${GROQ_API_KEY}" \
            https://api.groq.com/openai/v1/models)
          echo "Groq account 1 /models status: ${status}"
          if [ "${status}" != "200" ]; then
            echo "Groq account 1 healthcheck failed with status ${status}" >&2
            exit 1
          fi

      - name: Groq account 2 - models endpoint
        if: ${{ secrets.GROQ_API_KEY_2 != '' }}
        env:
          GROQ_API_KEY_2: ${{ secrets.GROQ_API_KEY_2 }}
        run: |
          set -euo pipefail
          status=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: Bearer ${GROQ_API_KEY_2}" \
            https://api.groq.com/openai/v1/models)
          echo "Groq account 2 /models status: ${status}"
          if [ "${status}" != "200" ]; then
            echo "Groq account 2 healthcheck failed with status ${status}" >&2
            exit 1
          fi

      - name: OpenRouter account 1 - models endpoint
        if: ${{ secrets.OPENROUTER_API_KEY != '' }}
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        run: |
          set -euo pipefail
          status=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: Bearer ${OPENROUTER_API_KEY}" \
            https://openrouter.ai/api/v1/models)
          echo "OpenRouter account 1 /models status: ${status}"
          if [ "${status}" != "200" ]; then
            echo "OpenRouter account 1 healthcheck failed with status ${status}" >&2
            exit 1
          fi

      - name: OpenRouter account 2 - models endpoint
        if: ${{ secrets.OPENROUTER_API_KEY_2 != '' }}
        env:
          OPENROUTER_API_KEY_2: ${{ secrets.OPENROUTER_API_KEY_2 }}
        run: |
          set -euo pipefail
          status=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: Bearer ${OPENROUTER_API_KEY_2}" \
            https://openrouter.ai/api/v1/models)
          echo "OpenRouter account 2 /models status: ${status}"
          if [ "${status}" != "200" ]; then
            echo "OpenRouter account 2 healthcheck failed with status ${status}" >&2
            exit 1
          fi

      - name: OpenAI - models endpoint
        if: ${{ secrets.OPENAI_API_KEY != '' }}
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          set -euo pipefail
          status=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: Bearer ${OPENAI_API_KEY}" \
            https://api.openai.com/v1/models)
          echo "OpenAI /models status: ${status}"
          if [ "${status}" != "200" ]; then
            echo "OpenAI healthcheck failed with status ${status}" >&2
            exit 1
          fi

      - name: Cloudflare - zone lookup
        if: ${{ secrets.CLOUDFLARE_API_TOKEN != '' && secrets.CLOUDFLARE_ZONE_ID != '' }}
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ZONE_ID: ${{ secrets.CLOUDFLARE_ZONE_ID }}
        run: |
          set -euo pipefail
          status=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: Bearer ${CLOUDFLARE_API_TOKEN}" \
            "https://api.cloudflare.com/client/v4/zones/${CLOUDFLARE_ZONE_ID}")
          echo "Cloudflare zone status: ${status}"
          if [ "${status}" != "200" ]; then
            echo "Cloudflare healthcheck failed with status ${status}" >&2
            exit 1
          fi

      - name: Snyk - self endpoint
        if: ${{ secrets.SNYK_TOKEN != '' }}
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: |
          set -euo pipefail
          status=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: token ${SNYK_TOKEN}" \
            https://api.snyk.io/rest/self?version=2024-06-10)
          echo "Snyk self status: ${status}"
          if [ "${status}" != "200" ]; then
            echo "Snyk healthcheck failed with status ${status}" >&2
            exit 1
          fi

      - name: Semgrep - organizations endpoint
        if: ${{ secrets.SEMGREP_APP_TOKEN != '' }}
        env:
          SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}
        run: |
          set -euo pipefail
          status=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: Bearer ${SEMGREP_APP_TOKEN}" \
            https://semgrep.dev/api/organizations)
          echo "Semgrep organizations status: ${status}"
          if [ "${status}" != "200" ]; then
            echo "Semgrep healthcheck failed with status ${status}" >&2
            exit 1
          fi

      - name: FOSSA - projects endpoint
        if: ${{ secrets.FOSSA_API_KEY != '' }}
        env:
          FOSSA_API_KEY: ${{ secrets.FOSSA_API_KEY }}
        run: |
          set -euo pipefail
          status=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: Bearer ${FOSSA_API_KEY}" \
            https://app.fossa.com/api/projects)
          echo "FOSSA projects status: ${status}"
          if [ "${status}" != "200" ]; then
            echo "FOSSA healthcheck failed with status ${status}" >&2
            exit 1
          fi

      - name: Qdrant API key presence
        if: ${{ secrets.QDRANT_API_KEY != '' }}
        env:
          QDRANT_API_KEY: ${{ secrets.QDRANT_API_KEY }}
        run: |
          set -euo pipefail
          if [ -z "${QDRANT_API_KEY}" ]; then
            echo "QDRANT_API_KEY is empty" >&2
            exit 1
          fi
          echo "QDRANT_API_KEY is present (not empty)."

      - name: Gmail SMTP credentials presence
        if: ${{ secrets.GMAIL_SMTP_USERNAME != '' && secrets.GMAIL_SMTP_CREDENTIALS != '' }}
        env:
          GMAIL_SMTP_USERNAME: ${{ secrets.GMAIL_SMTP_USERNAME }}
          GMAIL_SMTP_CREDENTIALS: ${{ secrets.GMAIL_SMTP_CREDENTIALS }}
        run: |
          set -euo pipefail
          if [ -z "${GMAIL_SMTP_USERNAME}" ] || [ -z "${GMAIL_SMTP_CREDENTIALS}" ]; then
            echo "Gmail SMTP secrets are empty" >&2
            exit 1
          fi
          echo "Gmail SMTP secrets are present (not empty)."
