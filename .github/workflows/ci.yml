name: CI

on:
  push:
    branches: [main]
  pull_request:
 
concurrency:
  group: ci-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true
 
jobs:
  build-test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        go: ["1.24.11"]
    steps:
      - uses: actions/checkout@v4
      - name: Install SOPS and AGE
        run: |
          set -e
          sudo apt-get update
          sudo apt-get install -y age
          SOPS_VERSION="3.8.1"
          curl -L "https://github.com/getsops/sops/releases/download/v${SOPS_VERSION}/sops-v${SOPS_VERSION}.linux.amd64" -o sops
          sudo install -m 0755 sops /usr/local/bin/sops
          sops --version
      - name: Prepare SOPS age key
        env:
          SOPS_AGE_KEY: ${{ secrets.SOPS_AGE_KEY }}
        run: |
          if [ -z "$SOPS_AGE_KEY" ]; then
            echo "SOPS_AGE_KEY not set; skipping SOPS age key setup"
            exit 0
          fi
          mkdir -p ~/.config/sops/age
          printf %s "$SOPS_AGE_KEY" > ~/.config/sops/age/keys.txt
          chmod 600 ~/.config/sops/age/keys.txt
      - name: Decrypt env for CI (.env from secrets/env.sops.yaml)
        run: |
          if [ ! -f secrets/env.sops.yaml ]; then
            echo "secrets/env.sops.yaml not found; skipping decrypt-env"
            exit 0
          fi
          make decrypt-env
      - name: Setup Go
        uses: actions/setup-go@v6.1.0
        with:
          go-version: ${{ matrix.go }}
          cache: true
      - name: Download deps
        run: go mod download
      - name: Tools
        run: make tools
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
      - name: Install frontend dependencies
        run: |
          cd admin-frontend
          npm ci
      - name: Build frontend
        run: |
          cd admin-frontend
          npm run build
      - name: Verify frontend build
        run: |
          test -d admin-frontend/dist || {
            echo "Frontend build missing" >&2; exit 1; }
      - name: Lint (backend/frontend/infra/docs)
        run: make lint-all
      - name: Vet
        run: make vet
      - name: Security - Vulnerabilities
        run: make vuln

      - name: Security - Gosec (SARIF)
        id: gosec-sarif
        run: make gosec-sarif
        continue-on-error: true

      - name: Upload Gosec results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always() && steps.gosec-sarif.conclusion == 'success'
        continue-on-error: true
        with:
          sarif_file: gosec-results.sarif

      - name: Security - License Check
        run: make license-scan
        env:
          FOSSA_API_KEY: ${{ secrets.FOSSA_API_KEY }}
        continue-on-error: true
      - name: Unit tests + coverage enforcement
        run: make ci-test
      - name: Upload unit coverage
        uses: actions/upload-artifact@v4
        with:
          name: coverage-unit-${{ matrix.go }}
          path: coverage/coverage.unit.out
      - name: Upload coverage to Codecov
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage/coverage.unit.out
          fail_ci_if_error: true
      - name: Validate OpenAPI
        run: make openapi-validate
      - name: Build docker images (smoke)
        run: |
          docker build -f deploy/docker/Dockerfile.server -t ${{ github.repository }}-server:${{ github.sha }} .
          docker build -f deploy/docker/Dockerfile.worker -t ${{ github.repository }}-worker:${{ github.sha }} .
          docker build -f deploy/docker/prod/Dockerfile.frontend -t ${{ github.repository }}-frontend:${{ github.sha }} .

      - name: Production - Multi-arch Build Test
        if: matrix.go == '1.24'
        run: make build-matrix
      - name: Enforce unit test placement
        run: make verify-test-placement
      
      # E2E tests on tags are handled in the deploy workflow's e2e-verify job

  playwright-e2e:
    if: github.event_name == 'pull_request'
    needs: build-test
    runs-on: ubuntu-latest
    timeout-minutes: 40
    steps:
      - uses: actions/checkout@v4

      - name: Install SOPS and AGE
        run: |
          set -e
          sudo apt-get update
          sudo apt-get install -y age
          SOPS_VERSION="3.8.1"
          curl -L "https://github.com/getsops/sops/releases/download/v${SOPS_VERSION}/sops-v${SOPS_VERSION}.linux.amd64" -o sops
          sudo install -m 0755 sops /usr/local/bin/sops
          sops --version

      - name: Prepare SOPS age key
        env:
          SOPS_AGE_KEY: ${{ secrets.SOPS_AGE_KEY }}
        run: |
          if [ -z "$SOPS_AGE_KEY" ]; then
            echo "SOPS_AGE_KEY not set; skipping SOPS age key setup"
            exit 0
          fi
          mkdir -p ~/.config/sops/age
          printf %s "$SOPS_AGE_KEY" > ~/.config/sops/age/keys.txt
          chmod 600 ~/.config/sops/age/keys.txt

      - name: Decrypt env for CI (.env from secrets/env.sops.yaml)
        run: |
          if [ ! -f secrets/env.sops.yaml ]; then
            echo "secrets/env.sops.yaml not found; skipping decrypt-env"
            exit 0
          fi
          make decrypt-env

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Playwright and frontend dependencies
        run: |
          cd admin-frontend
          npm ci
          npx playwright install --with-deps

      - name: Start observability stack (docker-compose)
        run: |
          docker compose up -d

      - name: Wait for backend readiness
        run: |
          set -e
          ATTEMPTS=60
          for i in $(seq 1 $ATTEMPTS); do
            if curl -fsS http://localhost:8080/readyz >/dev/null 2>&1; then
              echo "Backend is ready"
              exit 0
            fi
            echo "Waiting for backend readyz... ($i/$ATTEMPTS)"
            sleep 2
          done
          echo "Backend failed to become ready in time"
          docker compose ps
          exit 1

      - name: Run Playwright SSO + Grafana E2E spec
        run: |
          set -o pipefail
          cd admin-frontend
          mkdir -p playwright-report
          npm run test:e2e -- tests/sso-gate.spec.ts | tee playwright-report/playwright.log

      - name: Upload Playwright logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-e2e-logs
          path: admin-frontend/playwright-report

      - name: Dump docker logs on failure
        if: failure()
        run: |
          docker compose logs

      - name: Teardown observability stack
        if: always()
        run: |
          docker compose down -v
