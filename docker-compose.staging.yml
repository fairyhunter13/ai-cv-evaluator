# Staging environment overlay
# Usage: docker compose -f docker-compose.prod.yml -f docker-compose.staging.yml up -d
#
# This overlay provides a staging environment that mirrors production
# but with reduced resources and staging-specific configuration.

services:
  backend:
    environment:
      - APP_ENV=staging
      - CORS_ALLOW_ORIGINS=https://staging.ai-cv-evaluator.web.id,https://staging-dashboard.ai-cv-evaluator.web.id
      # Relaxed rate limits for testing
      - RATE_LIMIT_PER_MIN=120
      - OPENROUTER_MIN_INTERVAL=2s

  worker:
    environment:
      - APP_ENV=staging
      # Reduced concurrency for staging
      - CONSUMER_MAX_CONCURRENCY=2
    deploy:
      replicas: 1
      resources:
        limits:
          memory: 1G
          cpus: '1.0'

  db:
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'

  redpanda:
    command:
      - redpanda
      - start
      - --kafka-addr internal://0.0.0.0:9092,external://0.0.0.0:19092
      - --advertise-kafka-addr internal://redpanda:9092,external://localhost:19092
      - --pandaproxy-addr internal://0.0.0.0:8082,external://0.0.0.0:18082
      - --advertise-pandaproxy-addr internal://redpanda:8082,external://localhost:18082
      - --schema-registry-addr internal://0.0.0.0:8081,external://0.0.0.0:18081
      - --rpc-addr redpanda:33145
      - --advertise-rpc-addr redpanda:33145
      - --smp 1
      - --memory 512M
      - --default-log-level=info
    deploy:
      resources:
        limits:
          memory: 768M
          cpus: '0.5'

  oauth2-proxy-app:
    environment:
      OAUTH2_PROXY_REDIRECT_URL: https://staging.ai-cv-evaluator.web.id/oauth2/callback

  oauth2-proxy-dashboard:
    environment:
      OAUTH2_PROXY_REDIRECT_URL: https://staging-dashboard.ai-cv-evaluator.web.id/oauth2/callback

  keycloak:
    environment:
      KC_HOSTNAME: staging-keycloak.ai-cv-evaluator.web.id
    deploy:
      resources:
        limits:
          memory: 768M
          cpus: '0.5'

  grafana:
    environment:
      - GF_SERVER_ROOT_URL=https://staging.ai-cv-evaluator.web.id/grafana/
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.25'

  prometheus:
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.25'

  loki:
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.25'

  jaeger:
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.25'
